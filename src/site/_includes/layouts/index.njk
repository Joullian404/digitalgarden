<!DOCTYPE html>
<html lang="{{ meta.mainLanguage }}">
<head>
    <title>{% if title %}{{ title }}{% else %}{{ page.fileSlug }}{% endif %}</title>
    {%include "components/pageheader.njk"%}
    {% for imp in dynamics.common.head %}
        {% include imp %}
    {% endfor %}
    {% for imp in dynamics.index.head %}
        {% include imp %}
    {% endfor %}

    <!-- ============================================= -->
    <!-- ===== PASSO 1: SCRIPT DO NETLIFY IDENTITY ===== -->
    <!-- ============================================= -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- ============================================== -->
    <!-- ===== ESTILOS PARA O CONTROLE DE ACESSO ===== -->
    <!-- ============================================== -->
    <style>
      /* Esconde o conteúdo principal por padrão */
      #main-content {
        visibility: hidden; /* Usa visibility para evitar que a página "pule" */
      }
      
      /* Estilo para a tela de carregamento/login */
      #access-gate {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #121212;
        color: #FFF;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-family: sans-serif;
        text-align: center;
      }
      .gate-content button {
          font-size: 16px;
          padding: 12px 20px;
          border: none;
          background-color: #007bff;
          color: white;
          border-radius: 5px;
          cursor: pointer;
      }
    </style>
</head>

<body class="theme-{{meta.baseTheme}} markdown-preview-view markdown-rendered markdown-preview-section {{meta.bodyClasses}}">

  <!-- ============================================ -->
  <!-- ===== PASSO 2: TELA DE LOGIN (HTML) ===== -->
  <!-- ============================================ -->
  <div id="access-gate">
    <div class="gate-content">
      <h1>Acesso Restrito</h1>
      <p>Você precisa fazer login para ver este conteúdo.</p>
      <!-- O widget do Netlify vai criar um botão de Login/Logout aqui -->
      <div data-netlify-identity-menu></div>
    </div>
  </div>

  <!-- ===================================== -->
  <!-- ===== CONTEÚDO PRINCIPAL DO SITE ===== -->
  <!-- ===================================== -->
  <div id="main-content">

    {%include "components/notegrowthhistory.njk"%}
    {% if settings.dgShowFileTree !== true %}
      {%include "components/navbar.njk"%}
    {%else%}
      {%include "components/filetree.njk"%}
    {% endif %}
    {% if settings.dgEnableSearch === true %}
      {%include "components/searchContainer.njk"%}
    {% endif %}
    <main class="content cm-s-obsidian {{contentClasses}}">
      <header>
      {% if settings.dgShowInlineTitle === true %}
        <h1>{{ noteTitle  }}</h1>
      {% endif %}

      <div class="header-meta">
        {% if settings.dgShowTags === true and tags %}
          <div class="header-tags">
            {% for tag in tags %}
              {% if tag != 'gardenEntry' and tag !='note' %}
                <a class="tag" onclick="toggleTagSearch(this)">
                  #{{tag}}
                </a>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
      {% for imp in dynamics.common.header %}
        {% include imp %}
      {% endfor %}
      {% for imp in dynamics.index.header %}
        {% include imp %}
      {% endfor %}
      </header>
      {% for imp in dynamics.common.beforeContent %}
        {% include imp %}
      {% endfor %}
      {% for imp in dynamics.index.beforeContent %}
        {% include imp %}
      {% endfor %}
      {{ content | hideDataview | taggify | link | safe}}
      {% for imp in dynamics.common.afterContent %}
        {% include imp %}
      {% endfor %}
      {% for imp in dynamics.index.afterContent %}
        {% include imp %}
      {% endfor %}
    </main>

    {% if settings.dgShowBacklinks === true or settings.dgShowLocalGraph === true or settings.dgShowToc === true%}
      {%include "components/sidebar.njk" %}
    {%endif%}

    {% if settings.dgLinkPreview === true %}
      {%include "components/linkPreview.njk"%}
    {% endif %}
    {% for imp in dynamics.common.footer %}
      {% include imp %}
    {% endfor %}
    {% for imp in dynamics.index.footer %}
      {% include imp %}
    {% endfor %}
    {%include "components/lucideIcons.njk"%}
  </div>

  <!-- ================================================= -->
  <!-- ===== PASSO 3: LÓGICA (JAVASCRIPT) DO LOGIN ===== -->
  <!-- ================================================= -->
  <script>
    const accessGate = document.getElementById('access-gate');
    const mainContent = document.getElementById('main-content');

    // Função para mostrar o conteúdo
    const showContent = () => {
      accessGate.style.display = 'none';
      mainContent.style.visibility = 'visible';
    };
    
    // Função para mostrar a tela de login
    const showLoginGate = () => {
        accessGate.style.display = 'flex';
        mainContent.style.visibility = 'hidden';
    };

    // Evento que dispara quando o widget do Netlify Identity está pronto
    netlifyIdentity.on('init', user => {
      if (user) {
        // Se já existe um usuário logado, mostra o conteúdo
        showContent();
      } else {
        // Se não, mostra a tela de login
        showLoginGate();
      }
    });

    // Evento que dispara quando um usuário faz login
    netlifyIdentity.on('login', () => {
      showContent();
    });
    
    // Evento que dispara quando um usuário faz logout
    netlifyIdentity.on('logout', () => {
      showLoginGate();
    });

  </script>

</body>
</html>
